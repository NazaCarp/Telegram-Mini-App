<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mine</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at center, #0047ab, #002357, #000000);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* Evita que la imagen sea seleccionable */
            -webkit-tap-highlight-color: transparent; /* Deshabilita el resaltado en dispositivos Android */
            transition: filter 0.3s ease;
        }

        * {
            margin: 0px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .score {
            font-weight: bold;
            text-align: center;
            margin-top: 70px;
            font-size: 80px;
            display: flex;
            align-items: center;
        }
        
        .navbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            height: 60px;
            border-radius: 50px;
            margin: 0 auto; /* Centra la barra de navegación */
            background-color: #222222;
            position: fixed;
            bottom: 0;
            user-select: none; /* Evita que los íconos sean seleccionables */
            -webkit-tap-highlight-color: transparent; /* Deshabilita el resaltado en dispositivos Android */
            z-index: 1000; /* Asegura que la barra de navegación esté por encima del contenido */
        }
        
        .navbar a {
            color: gray;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            position: relative;
        }
        
        .navbar a.active span, .navbar a.active iconify-icon {
            color: white;
        }
        
        .navbar a iconify-icon {
            font-size: 24px;
        }
        
        .navbar a.active::before {
            content: '';
            position: absolute;
            top: -7px;
            left: -14px;
            right: -14px;
            bottom: -7px;
            border-radius: 50px;
            background-color: rgba(0, 0, 0, 0.267);
            z-index: -1;
        }
        
        .tabs {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            height: 60px;
            background-color: #222222;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .tabs a {
            color: gray;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            position: relative;
        }
        
        .tabs a.active span, .tabs a.active iconify-icon {
            color: white;
        }
        
        .tabs a iconify-icon {
            font-size: 24px;
        }
        
        .tabs a.active::before {
            content: '';
            position: absolute;
            top: -7px;
            left: -14px;
            right: -14px;
            bottom: -7px;
            border-radius: 50px;
            background-color: rgba(0, 0, 0, 0.267);
            z-index: -1;
        }
        
        .tab-content {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 60px;
            margin-bottom: 70px; /* Añadido para evitar que la barra de navegación tape el contenido */
        }
        
        .tab-content.active {
            display: flex;
        }
        
        .tab-container {
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .tab-text {
            display: none;
        }
        
        .tabs a.active .tab-text {
            display: inline;
        }

        .tab-slider {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }

        .tab-slide {
            flex: 0 0 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .rectangle {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #333;
            border-radius: 50px;
            border: 2px solid white;
            width: 95%;
            margin: 5px;
            padding: 5px;
            cursor: pointer;
        }
        
        .icon {
            margin: 10px;
            width: 75px;
            height: 75px;
            object-fit: contain; /* Asegura que la imagen se ajuste sin deformarse */
        }
        
        .row {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        
        .subtitle {
            font-size: 14px;
            color: gray;
            margin-top: 5px;
        }
        
        .profit-info {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .profit-info iconify-icon {
            font-size: 18px;
            margin-right: 5px;
        }
        
        .profit-info span {
            font-size: 16px;
            color: yellow;
        }

        .divider {
            width: 100%;
            height: 1px;
            background-color: rgb(255, 255, 255, 0.2);
            margin: 10px 0;
        }

        .vertical-divider {
            width: 1px;
            height: 100%;
            margin-left: 5px;
            margin-right: 5px;
            background-color: rgb(255, 255, 255, 0.2);
        }

        .section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .section-left {
            display: flex;
            justify-content: flex-end; /* Alinea el contenido a la derecha */
            align-items: center;
            flex: 4; /* 40% del espacio */
        }

        .section-right {
            display: flex;
            align-items: center;
            flex: 6; /* 60% del espacio */
        }

        .section-right iconify-icon {
            font-size: 18px;
            margin-right: 5px;
        }

        .section-right span {
            font-size: 16px;
            color: yellow;
        }

        .text-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
        }

        .blur-content {
            filter: blur(5px);
            pointer-events: none;
            transition: filter 0.3s ease;
        }

        .alert-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background-color: #333;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .alert-menu .icon {
            margin: 20px auto; /* Centrar el ícono */
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .alert-menu .icon img {
            max-width: 100%;
            max-height: 100%;
        }

        .alert-menu .close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        
        .alert-text {
            font-size: 24px;
        }
        
        .subtitle {
            margin-top: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .second-subtitle {
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .cost {
            font-size: 48px;
            margin-top: 25px;
            font-weight: bold;
        }
        
        .cost.yellow {
            color: yellow;
        }
        
        .cost.gray {
            color: gray;
        }
        
        .action-button {
            position: relative;
            overflow: hidden;
            width: 100%;
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        .action-button.active {
            background-color: #0066ff;
            color: white;
        }

        .action-button.inactive {
            background-color: #808080;
            color: white;
            cursor: not-allowed;
        }

        /* Estilos para la animación del botón */
        .action-button__text {
            position: relative;
            z-index: 1;
            transition: color 0.3s ease-in-out;
        }

        .action-button__progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            visibility: hidden;
        }

        .action-button__progress-track {
            stroke: rgba(255, 255, 255, 0.2);
            transition: r 0.3s ease-in-out, stroke-width 0.3s ease-in-out;
        }

        .action-button__progress-fill {
            stroke: white;
            stroke-dashoffset: 125.66;
            transition: stroke-dashoffset 2s linear;
        }

        .action-button__progress-check {
            stroke: white;
            stroke-dashoffset: 34;
            transition: stroke-dashoffset 0.3s ease-out;
        }

        .action-button--running,
        .action-button--done {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            background-color: transparent !important;
        }

        .action-button--running .action-button__text,
        .action-button--done .action-button__text {
            color: transparent;
        }

        .action-button--running .action-button__progress,
        .action-button--done .action-button__progress {
            visibility: visible;
        }

        .action-button--running .action-button__progress-track {
            stroke-width: 8;
        }

        .action-button--running .action-button__progress-fill {
            stroke-dashoffset: 0;
        }

        .action-button--done .action-button__progress-check {
            stroke-dashoffset: 0;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            transform: scale(0);
            animation: ripple-effect 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="score" id="scoreContainer">
            <iconify-icon icon="twemoji:coin" style="font-size: 60px;" id="coinIcon"></iconify-icon>
            <span id="scoreText">0</span>
        </div>
        <h5>Balance</h5>
        <div class="tabs">
            <a href="#" id="northAmericaTab" class="active"><iconify-icon icon="gis:earth-america"></iconify-icon><span class="tab-text">North America</span></a>
            <a href="#" id="southAmericaTab"><iconify-icon icon="game-icons:south-america"></iconify-icon><span class="tab-text">South America</span></a>
            <a href="#" id="europeTab"><iconify-icon icon="emojione-monotone:globe-showing-europe-africa"></iconify-icon><span class="tab-text">Europe</span></a>
            <a href="#" id="asiaTab"><iconify-icon icon="gis:earth-asia-o"></iconify-icon><span class="tab-text">Asia</span></a>
            <a href="#" id="africaTab"><iconify-icon icon="game-icons:africa"></iconify-icon><span class="tab-text">Africa</span></a>
            <a href="#" id="oceaniaTab"><iconify-icon icon="game-icons:earth-asia-oceania"></iconify-icon><span class="tab-text">Oceania</span></a>
        </div>
        <div class="tab-container">
            <div class="tab-slider" id="tabSlider">
                <div class="tab-slide" id="northAmericaContent"></div>
                <div class="tab-slide" id="southAmericaContent"></div>
                <div class="tab-slide" id="europeContent"></div>
                <div class="tab-slide" id="asiaContent"></div>
                <div class="tab-slide" id="africaContent"></div>
                <div class="tab-slide" id="oceaniaContent"></div>
            </div>
        </div>
    </div>
    <div class="navbar">
        <a href="index.html" id="exchangeNav"><iconify-icon icon="simple-icons:binance"></iconify-icon><span>Exchange</span></a>
        <a href="mine.html" id="mineNav" class="active"><iconify-icon icon="mdi:pickaxe"></iconify-icon><span>Mine</span></a>
        <a href="friends.html" id="friendsNav"><iconify-icon icon="clarity:group-solid"></iconify-icon><span>Friends</span></a>
        <a href="earn.html" id="earnNav"><iconify-icon icon="fa6-solid:coins"></iconify-icon><span>Earn</span></a>
        <a href="index.html#airdrop" id="airdropNav"><iconify-icon icon="et:wallet"></iconify-icon><span>Airdrop</span></a>
    </div>
    <div class="alert-menu" id="alertMenu">
        <div class="close" onclick="closeAlertMenu()"><iconify-icon icon="ph:x-circle-duotone"></iconify-icon></div>
        <div class="icon" id="alertIcon"></div>
        <div class="alert-text" id="alertText"></div>
        <div class="subtitle" id="alertSubtitle"></div>
        <div class="second-subtitle" id="alertSecondSubtitle"></div>
        <div class="cost" id="alertCost"></div>
        <button class="action-button" id="actionButton">
            <span class="action-button__text">Buy</span>
            <svg class="action-button__progress" viewBox="0 0 48 48" width="48px" height="48px">
                <circle class="action-button__progress-track" r="20" cx="24" cy="24" fill="none" stroke="#c7cad1" stroke-width="8" />
                <circle class="action-button__progress-fill" r="20" cx="24" cy="24" fill="none" stroke="#ffffff" stroke-width="8" transform="rotate(-90,24,24)" stroke-dasharray="125.66 125.66" stroke-dashoffset="125.66" />
                <polyline class="action-button__progress-check" points="12,24 20,32 36,16" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="34 34" stroke-dashoffset="34" />
            </svg>
        </button>
    </div>
    <script>
        let levels;
        const tg = window.Telegram.WebApp;
        const user_id = tg.initDataUnsafe.user.id;

        let score = 0;
        let profitPerHour = 0;
        let currentTabIndex = 0; // Variable para mantener el índice de la pestaña activa
        let currentActionButtonListener = null;
        let isButtonAnimating = false;

        async function loadScore() {
            let storedScore = localStorage.getItem(`score_${user_id}`);
            let storedProfitPerHour = localStorage.getItem(`profit_per_hour_${user_id}`);
            let lastTimestamp = localStorage.getItem(`lastTimestamp_${user_id}`);
            
            const currentTime = Date.now();
            const timeElapsed = (currentTime - lastTimestamp) / 1000; // tiempo en segundos

            if (storedScore === null || storedProfitPerHour === null || isNaN(parseFloat(storedScore)) || isNaN(parseFloat(storedProfitPerHour)) || timeElapsed > 300) { // 5 minutos
                try {
                    const response = await fetch(`/get_counters?user_id=${user_id}`);
                    const data = await response.json();
                    storedScore = data.score;
                    storedProfitPerHour = data.profit_per_hour;
                } catch (error) {
                    console.error('Error fetching score data:', error);
                    // Si hay un error, usamos los valores almacenados o 0 si no existen
                    storedScore = storedScore || '0';
                    storedProfitPerHour = storedProfitPerHour || '0';
                }
            } else {
                // Actualizar el score basado en el tiempo transcurrido
                storedScore = parseFloat(storedScore) + (parseFloat(storedProfitPerHour) / 3600) * timeElapsed;
            }
            
            // Convertir los valores almacenados en números
            score = parseFloat(storedScore);
            profitPerHour = parseFloat(storedProfitPerHour);

            // Actualizar la interfaz del usuario
            document.getElementById('scoreText').textContent = formatNumber(score);
            
            // Guardar score y profitPerHour en localStorage
            localStorage.setItem(`score_${user_id}`, score);
            localStorage.setItem(`profit_per_hour_${user_id}`, profitPerHour);
            localStorage.setItem(`lastTimestamp_${user_id}`, currentTime);
            
            // Iniciar el intervalo para incrementar el score cada segundo
            setInterval(incrementScore, 1000);
        }

        function incrementScore() {
            score += profitPerHour / 3600;
            document.getElementById('scoreText').textContent = formatNumber(score);
            localStorage.setItem(`score_${user_id}`, score);
            localStorage.setItem(`lastTimestamp_${user_id}`, Date.now());

            // Actualizar el score en la base de datos
            saveCounts();
        }

        function formatNumber(num) {
            const basicUnits = ['', 'K', 'M', 'B', 'T', 'Q'];
            
            function generateUnit(n) {
                if (n < basicUnits.length) return basicUnits[n];
                
                let firstChar = String.fromCharCode(Math.floor((n - basicUnits.length) / 26) + 65);
                let secondChar = String.fromCharCode((n - basicUnits.length) % 26 + 65);
                return firstChar + secondChar;
            }

            let unitIndex = 0;
            while (num >= 1000 && unitIndex < 702) { // 702 = 26 * 27 (AA to ZZ)
                num /= 1000;
                unitIndex++;
            }

            return num.toFixed(2) + generateUnit(unitIndex);
        }

        async function saveCounts() {
            fetch('/update_counters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: user_id, score: score })
            });
        }

        async function loadMineLevels() {
            let storedLevels = localStorage.getItem(`mine_levels_${user_id}`);
            
            if (!storedLevels) {
                try {
                    const response = await fetch(`/get_mine_levels?user_id=${user_id}`);
                    const data = await response.json();
                    levels = data.clubs;
                    localStorage.setItem(`mine_levels_${user_id}`, JSON.stringify(levels));
                } catch (error) {
                    console.error('Error fetching mine levels:', error);
                    levels = {}; // Objeto vacío en caso de error
                }
            } else {
                levels = JSON.parse(storedLevels);
            }
            
            return levels;
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        function generateRectangles(containerId, clubs) {
            const rows = Math.ceil(clubs.length / 2);

            // Limpiar contenido anterior
            const height = 233 * rows + 100;

            const containernorth = document.getElementById('northAmericaContent');
            containernorth.style = `height: ${height}px;`
            
            const containersouth = document.getElementById('southAmericaContent');
            containersouth.style = `height: ${height}px;`

            const containereurope = document.getElementById('europeContent');
            containereurope.style = `height: ${height}px;`
            
            const containerasia = document.getElementById('asiaContent');
            containerasia.style = `height: ${height}px;`
            
            const containerafrica = document.getElementById('africaContent');
            containerafrica.style = `height: ${height}px;`

            const containeroceania = document.getElementById('oceaniaContent');
            containeroceania.style = `height: ${height}px;`
            
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Limpiar contenido anterior

            for (let i = 0; i < rows; i++) {
                const row = document.createElement('div');
                row.className = 'row';

                for (let j = 0; j < 2; j++) {
                    const index = i * 2 + j;
                    if (index >= clubs.length) break; // Salir si no hay más clubes

                    const club = clubs[index];
                    const level = levels[club.name] || 1;

                    // Calcular cost y profitPerHour basados en el nivel
                    let cost = calculateCost(club.cost, level);
                    let clubProfitPerHour = calculateProfitPerHour(club.cost, level, club.name);

                    const rectangle = document.createElement('div');
                    rectangle.className = 'rectangle';
                    rectangle.setAttribute('data-cost', cost); // Añadir el costo como atributo
                    rectangle.setAttribute('data-club-id', club.name); // Añadir el identificador del club

                    const imageElement = document.createElement('img');
                    imageElement.className = 'icon';
                    imageElement.src = club.image;
                    imageElement.alt = club.name;

                    const textContent = document.createElement('div');
                    textContent.className = 'text-content';

                    const title = document.createElement('h3');
                    title.style.fontSize = '14px'; // Tamaño de letra más chico
                    title.textContent = club.name;

                    const subtitle = document.createElement('div');
                    subtitle.className = 'subtitle';
                    subtitle.textContent = 'Profit per hour';

                    const profitInfo = document.createElement('div');
                    profitInfo.className = 'profit-info';
                    const profitIcon = document.createElement('iconify-icon');
                    profitIcon.icon = 'twemoji:coin';
                    const profitSpan = document.createElement('span');
                    profitSpan.textContent = formatNumber(clubProfitPerHour);

                    profitInfo.appendChild(profitIcon);
                    profitInfo.appendChild(profitSpan);

                    const divider = document.createElement('div');
                    divider.className = 'divider';

                    const section = document.createElement('div');
                    section.className = 'section';

                    const sectionLeft = document.createElement('div');
                    sectionLeft.className = 'section-left';
                    sectionLeft.textContent = `lvl ${level}`;

                    const verticalDivider = document.createElement('div');
                    verticalDivider.className = 'vertical-divider';

                    const sectionRight = document.createElement('div');
                    sectionRight.className = 'section-right';
                    const sectionRightIcon = document.createElement('iconify-icon');
                    sectionRightIcon.icon = 'twemoji:coin';
                    const sectionRightSpan = document.createElement('span');
                    sectionRightSpan.textContent = formatNumber(cost);

                    sectionRight.appendChild(sectionRightIcon);
                    sectionRight.appendChild(sectionRightSpan);

                    section.appendChild(sectionLeft);
                    section.appendChild(verticalDivider);
                    section.appendChild(sectionRight);

                    textContent.appendChild(title);
                    textContent.appendChild(subtitle);
                    textContent.appendChild(profitInfo);
                    textContent.appendChild(divider);
                    textContent.appendChild(section);

                    rectangle.appendChild(imageElement);
                    rectangle.appendChild(textContent);
                    row.appendChild(rectangle);

                    // Añadir evento de clic para mostrar la alerta
                    rectangle.addEventListener('click', () => {
                        cost = calculateCost(club.cost, levels[club.name] || 1);
                        clubProfitPerHour = calculateProfitPerHour(club.cost, levels[club.name], club.name);
                        showAlert(club, cost, clubProfitPerHour, clubs);
                    });
                }

                container.appendChild(row);
            }
        }

        function calculateCost(initialCost, level) {
            return initialCost * Math.pow(1.1, (level * (level - 1)) / 2);
        }

        function calculateProfitPerHour(initialCost, level, name) {
            let clubProfitPerHour = Math.round(initialCost * ((simpleHash(name) % 1200) / 10000 + 0.01)) // Inicialmente, clubProfitPerHour vale entre el 1% y el 12% del costo inicial
            for (let i = 2; i <= level; i++) {
                clubProfitPerHour += initialCost * (0.003 + i * 0.001);
            }
            return clubProfitPerHour;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const mineNav = document.getElementById('mineNav');
            mineNav.addEventListener('click', function(event) {
                if (window.location.pathname.includes('mine.html')) {
                    event.preventDefault();
                }
            });

            await loadScore();
            levels = await loadMineLevels();

            const tabs = document.querySelectorAll('.tabs a');
            const tabSlider = document.getElementById('tabSlider');

            const northAmericaClubs = [
                { name: 'Inter Miami CF', image: '/static/images/North America/Inter Miami CF.svg', cost: 7823 },
                { name: 'Houston Dynamo FC', image: '/static/images/North America/Houston Dynamo FC.svg', cost: 3159 },
                { name: 'Los Angeles Galaxy', image: '/static/images/North America/Los Angeles Galaxy.svg', cost: 9467 },
                { name: 'CF Montreal', image: '/static/images/North America/CF Montreal.svg', cost: 2614 },
                { name: 'New York Red Bulls', image: '/static/images/North America/New York Red Bulls.svg', cost: 5981 },
                { name: 'Seattle Sounders FC', image: '/static/images/North America/Seattle Sounders FC.svg', cost: 8302 },
                { name: 'Atlanta United FC', image: '/static/images/North America/Atlanta United FC.svg', cost: 4736 },
                { name: 'DC United', image: '/static/images/North America/DC United.svg', cost: 1895 },
                { name: 'FC Dallas', image: '/static/images/North America/FC Dallas.svg', cost: 6248 },
                { name: 'Los Angeles FC', image: '/static/images/North America/Los Angeles FC.svg', cost: 9573 },
                { name: 'Minnesota United FC', image: '/static/images/North America/Minnesota United FC.svg', cost: 3741 },
                { name: 'Nashville SC', image: '/static/images/North America/Nashville SC.svg', cost: 7109 },
                { name: 'Orlando City SC', image: '/static/images/North America/Orlando City SC.svg', cost: 5624 },
                { name: 'Philadelphia Union', image: '/static/images/North America/Philadelphia Union.svg', cost: 8937 },
                { name: 'Portland Timbers', image: '/static/images/North America/Portland Timbers.svg', cost: 2483 },
                { name: 'San Jose Earthquakes', image: '/static/images/North America/San Jose Earthquakes.svg', cost: 6795 },
                { name: 'Club America', image: '/static/images/North America/Club America.svg', cost: 4128 },
                { name: 'Cruz Azul', image: '/static/images/North America/Cruz Azul.svg', cost: 9361 },
                { name: 'Chivas Guadalajara', image: '/static/images/North America/Chivas Guadalajara.svg', cost: 1574 },
                { name: 'Monterrey', image: '/static/images/North America/Monterrey.svg', cost: 7846 },
                { name: 'Necaxa', image: '/static/images/North America/Necaxa.svg', cost: 3259 },
                { name: 'Pachuca', image: '/static/images/North America/Pachuca.svg', cost: 5917 },
                { name: 'Pumas UNAM', image: '/static/images/North America/Pumas UNAM.svg', cost: 8432 },
                { name: 'Tigres UANL', image: '/static/images/North America/Tigres UANL.svg', cost: 2695 },
                { name: 'Toluca', image: '/static/images/North America/Toluca.svg', cost: 6183 }
            ];

            const southAmericaClubs = [
                { name: 'Santos FC', image: '/static/images/South America/Santos FC.svg', cost: 4729 },
                { name: 'Club Libertad', image: '/static/images/South America/Club Libertad.svg', cost: 8156 },
                { name: 'Boca Juniors', image: '/static/images/South America/Boca Juniors.svg', cost: 3847 },
                { name: 'River Plate', image: '/static/images/South America/River Plate.svg', cost: 9235 },
                { name: 'Colo-Colo', image: '/static/images/South America/Colo-Colo.svg', cost: 1692 },
                { name: 'Independiente', image: '/static/images/South America/Independiente.svg', cost: 7384 },
                { name: 'Flamengo', image: '/static/images/South America/Flamengo.svg', cost: 100 },
                { name: 'Palmeiras', image: '/static/images/South America/Palmeiras.svg', cost: 2468 },
                { name: 'Nacional', image: '/static/images/South America/Nacional.svg', cost: 8739 },
                { name: 'Peñarol', image: '/static/images/South America/Peñarol.svg', cost: 6175 },
                { name: 'São Paulo FC', image: '/static/images/South America/São Paulo FC.svg', cost: 3592 },
                { name: 'Cruzeiro EC', image: '/static/images/South America/Cruzeiro EC.svg', cost: 9814 },
                { name: 'Grêmio FBPA', image: '/static/images/South America/Gremio FPBA.svg', cost: 1357 },
                { name: 'Internacional', image: '/static/images/South America/Internacional.svg', cost: 7629 },
                { name: 'Estudiantes de La Plata', image: '/static/images/South America/Estudiantes de La Plata.svg', cost: 4981 },
                { name: 'Racing Club', image: '/static/images/South America/Racing Club.svg', cost: 2845 },
                { name: 'Olimpia', image: '/static/images/South America/Olimpia.svg', cost: 6237 },
                { name: 'Cerro Porteño', image: '/static/images/South America/Cerro Porteño.svg', cost: 9473 },
                { name: 'Universidad de Chile', image: '/static/images/South America/Universidad de Chile.svg', cost: 5168 },
                { name: 'Universitario', image: '/static/images/South America/Universitario.svg', cost: 3726 },
                { name: 'Alianza Lima', image: '/static/images/South America/Alianza Lima.svg', cost: 8294 },
                { name: 'The Strongest', image: '/static/images/South America/The Strongest.svg', cost: 1985 },
                { name: 'Club Bolívar', image: '/static/images/South America/Club Bolivar.svg', cost: 7542 },
                { name: 'Emelec', image: '/static/images/South America/Emelec.svg', cost: 4619 },
                { name: 'LDU Quito', image: '/static/images/South America/LDU Quito.svg', cost: 9137 }
            ];

            const europeClubs = [
                { name: 'FC Barcelona', image: '/static/images/Europe/FC Barcelona.svg', cost: 8756 },
                { name: 'Real Madrid CF', image: '/static/images/Europe/Real Madrid CF.svg', cost: 3214 },
                { name: 'Manchester United FC', image: '/static/images/Europe/Manchester United FC.svg', cost: 6879 },
                { name: 'Bayern Munich', image: '/static/images/Europe/Bayern Munich.svg', cost: 9543 },
                { name: 'Paris Saint-Germain FC', image: '/static/images/Europe/Paris Saint-Germain FC.svg', cost: 2167 },
                { name: 'Liverpool FC', image: '/static/images/Europe/Liverpool FC.svg', cost: 7395 },
                { name: 'Chelsea FC', image: '/static/images/Europe/Chelsea FC.svg', cost: 4628 },
                { name: 'Arsenal FC', image: '/static/images/Europe/Arsenal FC.svg', cost: 1952 },
                { name: 'AC Milan', image: '/static/images/Europe/AC Milan.svg', cost: 8374 },
                { name: 'Inter Milan', image: '/static/images/Europe/Inter Milan.svg', cost: 5719 },
                { name: 'Juventus FC', image: '/static/images/Europe/Juventus FC.svg', cost: 3846 },
                { name: 'Borussia Dortmund', image: '/static/images/Europe/Borussia Dortmund.svg', cost: 9281 },
                { name: 'Atletico Madrid', image: '/static/images/Europe/Atletico Madrid.svg', cost: 6537 },
                { name: 'Manchester City FC', image: '/static/images/Europe/Manchester City FC.svg', cost: 1794 },
                { name: 'Tottenham Hotspur FC', image: '/static/images/Europe/Tottenham Hotspur FC.svg', cost: 7928 },
                { name: 'Napoli', image: '/static/images/Europe/Napoli.svg', cost: 4165 },
                { name: 'AS Roma', image: '/static/images/Europe/AS Roma.svg', cost: 2639 },
                { name: 'FC Porto', image: '/static/images/Europe/FC Porto.svg', cost: 8492 },
                { name: 'Benfica', image: '/static/images/Europe/Benfica.svg', cost: 5316 },
                { name: 'Ajax Amsterdam', image: '/static/images/Europe/Ajax Amsterdam.svg', cost: 3784 }
            ];

            const asiaClubs = [
                { name: 'Al-Hilal SFC', image: '/static/images/Asia/Al-Hilal SFC.svg', cost: 6921 },
                { name: 'Al-Ain FC', image: '/static/images/Asia/Al-Ain FC.svg', cost: 4378 },
                { name: 'Persepolis FC', image: '/static/images/Asia/Persepolis FC.svg', cost: 1835 },
                { name: 'Al-Sadd SC', image: '/static/images/Asia/Al-Sadd SC.svg', cost: 9267 },
                { name: 'Urawa Red Diamonds', image: '/static/images/Asia/Urawa Red Diamonds.svg', cost: 7594 },
                { name: 'Jeonbuk Hyundai Motors FC', image: '/static/images/Asia/Jeonbuk Hyundai Motors FC.svg', cost: 3142 },
                { name: 'Guangzhou Evergrande FC', image: '/static/images/Asia/Guangzhou Evergrande FC.svg', cost: 5786 },
                { name: 'Al-Nassr FC', image: '/static/images/Asia/Al-Nassr FC.svg', cost: 2419 },
                { name: 'FC Tokyo', image: '/static/images/Asia/FC Tokyo.svg', cost: 8653 },
                { name: 'Al-Jazira Club', image: '/static/images/Asia/Al-Jazira Club.svg', cost: 6297 },
                { name: 'Esteghlal FC', image: '/static/images/Asia/Esteghlal FC.svg', cost: 4731 },
                { name: 'Sepahan FC', image: '/static/images/Asia/Sepahan FC.svg', cost: 1968 },
                { name: 'Al-Rayyan SC', image: '/static/images/Asia/Al-Rayyan SC.svg', cost: 9384 },
                { name: 'Al-Wahda FC', image: '/static/images/Asia/Al-Wahda FC.svg', cost: 7126 },
                { name: 'Shanghai SIPG FC', image: '/static/images/Asia/Shanghai SIPG FC.svg', cost: 3579 },
                { name: 'Jeju United FC', image: '/static/images/Asia/Jeju United FC.svg', cost: 5842 },
                { name: 'FC Seoul', image: '/static/images/Asia/FC Seoul.svg', cost: 2317 },
                { name: 'Suwon Samsung Bluewings', image: '/static/images/Asia/Suwon Samsung Bluewings.svg', cost: 8795 },
                { name: 'Al-Ittihad FC', image: '/static/images/Asia/Al-Ittihad FC.svg', cost: 6534 },
                { name: 'Al-Ahli SC', image: '/static/images/Asia/Al-Ahli SC.svg', cost: 4189 }
            ];

            const africaClubs = [
                { name: 'Al-Ahly SC', image: '/static/images/Africa/Al-Ahly SC.svg', cost: 7863 },
                { name: 'Esperance de Tunis', image: '/static/images/Africa/Esperance de Tunis.svg', cost: 3529 },
                { name: 'Kaizer Chiefs FC', image: '/static/images/Africa/Kaizer Chiefs FC.svg', cost: 9176 },
                { name: 'Mamelodi Sundowns FC', image: '/static/images/Africa/Mamelodi Sundowns FC.svg', cost: 5742 },
                { name: 'Wydad AC', image: '/static/images/Africa/Wydad AC.svg', cost: 1985 },
                { name: 'TP Mazembe', image: '/static/images/Africa/TP Mazembe.svg', cost: 8324 },
                { name: 'ES Setif', image: '/static/images/Africa/ES Setif.svg', cost: 4697 },
                { name: 'Al-Hilal Omdurman', image: '/static/images/Africa/Al-Hilal Omdurman.svg', cost: 2153 },
                { name: 'Zamalek SC', image: '/static/images/Africa/Zamalek SC.svg', cost: 6918 },
                { name: 'Orlando Pirates FC', image: '/static/images/Africa/Orlando Pirates FC.svg', cost: 9485 },
                { name: 'Asante Kotoko SC', image: '/static/images/Africa/Asante Kotoko SC.svg', cost: 3762 },
                { name: 'JS Kabylie', image: '/static/images/Africa/JS Kabylie.svg', cost: 7239 },
                { name: 'CS Sfaxien', image: '/static/images/Africa/CS Sfaxien.svg', cost: 5814 },
                { name: 'ASEC Mimosas', image: '/static/images/Africa/ASEC Mimosas.svg', cost: 1397 },
                { name: 'Club Africain', image: '/static/images/Africa/Club Africain.svg', cost: 8652 },
                { name: 'Al-Merrikh SC', image: '/static/images/Africa/Al-Merrikh SC.svg', cost: 4129 },
                { name: 'Enyimba FC', image: '/static/images/Africa/Enyimba FC.svg', cost: 6573 },
                { name: 'Raja CA', image: '/static/images/Africa/Raja CA.svg', cost: 2946 },
                { name: 'Cotonsport FC', image: '/static/images/Africa/Cotonsport FC.svg', cost: 9381 },
                { name: 'Horoya AC', image: '/static/images/Africa/Horoya AC.svg', cost: 5729 }
            ];

            const oceaniaClubs = [
                { name: 'Sydney FC', image: '/static/images/Oceania/Sydney FC.svg', cost: 8246 },
                { name: 'Wellington Phoenix FC', image: '/static/images/Oceania/Wellington Phoenix FC.svg', cost: 3917 },
                { name: 'Melbourne Victory FC', image: '/static/images/Oceania/Melbourne Victory FC.svg', cost: 6582 },
                { name: 'Perth Glory FC', image: '/static/images/Oceania/Perth Glory FC.svg', cost: 1735 },
                { name: 'Auckland City FC', image: '/static/images/Oceania/Auckland City FC.svg', cost: 9463 },
                { name: 'Team Wellington', image: '/static/images/Oceania/Team Wellington.svg', cost: 4129 },
                { name: 'Hobart Zebras FC', image: '/static/images/Oceania/Hobart Zebras FC.svg', cost: 7894 },
                { name: 'Canberra United FC', image: '/static/images/Oceania/Canberra United FC.svg', cost: 2651 },
                { name: 'Brisbane Roar FC', image: '/static/images/Oceania/Brisbane Roar FC.svg', cost: 5378 },
                { name: 'Central Coast Mariners FC', image: '/static/images/Oceania/Central Coast Mariners FC.svg', cost: 8742 },
                { name: 'Tasmania United FC', image: '/static/images/Oceania/Tasmania United FC.svg', cost: 3196 },
                { name: 'Waitakere United FC', image: '/static/images/Oceania/Waitakere United FC.svg', cost: 6957 },
                { name: 'Eastern Suburbs AFC', image: '/static/images/Oceania/Eastern Suburbs AFC.svg', cost: 1584 },
                { name: 'South Melbourne FC', image: '/static/images/Oceania/South Melbourne FC.svg', cost: 9325 },
                { name: 'Heidelberg United FC', image: '/static/images/Oceania/Heidelberg United FC.svg', cost: 4768 },
                { name: 'Oakleigh Cannons FC', image: '/static/images/Oceania/Oakleigh Cannons FC.svg', cost: 7139 },
                { name: 'Lae City Dwellers FC', image: '/static/images/Oceania/Lae City Dwellers FC.svg', cost: 2873 },
                { name: 'Hekari United FC', image: '/static/images/Oceania/Hekari United FC.svg', cost: 5621 },
                { name: 'Tafea FC', image: '/static/images/Oceania/Tafea FC.svg', cost: 8497 },
                { name: 'Amicale FC', image: '/static/images/Oceania/Amicale FC.svg', cost: 3942 }
            ];

            tabs.forEach((tab, index) => {
                tab.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (currentTabIndex === index) return; // Si la pestaña activa es la misma, no hacer nada
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    currentTabIndex = index; // Actualizar el índice de la pestaña activa
                    tabSlider.style.transform = `translateX(-${currentTabIndex * 100}%)`;

                    // Generar rectángulos según la pestaña activa
                    switch (tab.id.replace('Tab', 'Content')) {
                        case 'northAmericaContent':
                            generateRectangles('northAmericaContent', northAmericaClubs);
                            break;
                        case 'southAmericaContent':
                            generateRectangles('southAmericaContent', southAmericaClubs);
                            break;
                        case 'europeContent':
                            generateRectangles('europeContent', europeClubs);
                            break;
                        case 'asiaContent':
                            generateRectangles('asiaContent', asiaClubs);
                            break;
                        case 'africaContent':
                            generateRectangles('africaContent', africaClubs);
                            break;
                        case 'oceaniaContent':
                            generateRectangles('oceaniaContent', oceaniaClubs);
                            break;
                    }
                });
            });

            // Generar rectángulos iniciales para la pestaña activa por defecto
            generateRectangles('northAmericaContent', northAmericaClubs);

            tg.onEvent('backButtonClicked', () => {
                window.location.href = 'index.html';
            });

            tg.BackButton.show();

            let startX = 0;
            let endX = 0;
            let isSliding = false;

            tabSlider.addEventListener('touchstart', (event) => {
                startX = event.touches[0].clientX;
                isSliding = true;
            });

            tabSlider.addEventListener('touchend', (event) => {
                endX = event.changedTouches[0].clientX;
                isSliding = false;

                const deltaX = endX - startX;
                const threshold = 50; // Umbral para considerar un deslizamiento
                let nextTab = currentTabIndex

                if (Math.abs(deltaX) > threshold) {
                    if (deltaX > 0 && currentTabIndex > 0) {
                        // Deslizamiento hacia la izquierda (anterior pestaña)
                        nextTab--;
                    } else if (deltaX < 0 && currentTabIndex < tabs.length - 1) {
                        // Deslizamiento hacia la derecha (siguiente pestaña)
                        nextTab++;
                    }

                    if (nextTab !== currentTabIndex) {
                        // Comprobar que la pestaña sea una diferente a la que ya se encuentra actualmente
                        tabs[nextTab].click();
                    }
                }
            });

            tabSlider.addEventListener('touchmove', (event) => {
                if (isSliding) {
                    endX = event.touches[0].clientX;
                }
            });

            // Agregar evento para cerrar la alerta al hacer clic fuera de ella
            document.addEventListener('click', function(event) {
                const alertMenu = document.getElementById('alertMenu');
                if (alertMenu && !alertMenu.contains(event.target) && !event.target.closest('.rectangle')) {
                    closeAlertMenu();
                }
            });
        });

        async function updateMineLevel(user_id, club_id, level) {
            const response = await fetch('/update_mine_level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id, club_id, level })
            });
            return await response.json();
        }
        
        async function updateProfitPerHour(user_id, clubProfitPerHour) {
            const response = await fetch('/update_profit_per_hour', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id, clubProfitPerHour })
            });
            return await response.json();
        }

        async function showAlert(club, cost, clubProfitPerHour, clubs) {
            // Obtener el nivel actual del club
            const currentLevel = levels[club.name] || 1;
            
            // Calcular el costo y profit actuales basados en el nivel actual
            const currentCost = calculateCost(club.cost, currentLevel);
            const currentProfitPerHour = calculateProfitPerHour(club.cost, currentLevel, club.name);

            const costColor = currentCost <= score ? 'yellow' : 'gray';
            const buttonClass = currentCost <= score ? 'active' : 'inactive';

            document.getElementById('alertIcon').innerHTML = `<img src="${club.image}" alt="${club.name}" style="width: 50%; height: 50%;">`;
            document.getElementById('alertText').innerText = club.name;
            document.getElementById('alertSubtitle').innerText = 'Profit per hour';
            document.getElementById('alertSecondSubtitle').innerText = `${formatNumber(currentProfitPerHour)}`;
            document.getElementById('alertCost').innerHTML = `<p><iconify-icon icon="twemoji:coin" style="font-size: 35px;"></iconify-icon> ${formatNumber(currentCost)}</p>`;
            document.getElementById('alertCost').classList.remove('yellow', 'gray');
            document.getElementById('alertCost').classList.add(costColor);
            document.getElementById('actionButton').classList.remove('active', 'inactive');
            document.getElementById('actionButton').classList.add(buttonClass);
            document.getElementById('alertMenu').style.display = 'block';
            document.querySelector('.container').classList.add('blur-content');
            document.querySelector('.navbar').classList.add('blur-content');

            // Eliminar el evento anterior si existe
            if (currentActionButtonListener) {
                document.getElementById('actionButton').removeEventListener('click', currentActionButtonListener);
            }

            // Asignar un nuevo evento
            currentActionButtonListener = async (event) => {
                if (document.getElementById('actionButton').classList.contains('active') && !isButtonAnimating) {
                    isButtonAnimating = true;
                    const button = event.currentTarget;
                    const track = button.querySelector('.action-button__progress-track');
                    const fill = button.querySelector('.action-button__progress-fill');
                    const check = button.querySelector('.action-button__progress-check');
                    
                    // Reset animation state
                    fill.style.transition = 'none';
                    fill.style.strokeDashoffset = '125.66';
                    check.style.transition = 'none';
                    check.style.strokeDashoffset = '34';
                    
                    // Force reflow
                    void button.offsetWidth;
                    
                    // Add a small delay before adding the running class
                    setTimeout(() => {
                        button.classList.add('action-button--running');
                    }, 10);
                    
                    // Start animations
                    fill.style.transition = 'stroke-dashoffset 2s 0.5s linear';
                    fill.style.strokeDashoffset = '0';
                    
                    setTimeout(async () => {
                        button.classList.remove('action-button--running');
                        button.classList.add('action-button--done');
                        
                        check.style.transition = 'stroke-dashoffset 0.3s ease-in-out';
                        check.style.strokeDashoffset = '0';
                        
                        const club_id = club.name;
                        if (score >= currentCost) {
                            let newLevel = currentLevel + 1;
                            score -= currentCost;
                            result = await updateMineLevel(user_id, club_id, newLevel);
                            if (result.status === 'success') {
                                document.getElementById('scoreText').textContent = formatNumber(score)
                                levels = result.updated_clubs; // Actualizar el objeto levels completo
                                localStorage.setItem(`mine_levels_${user_id}`, JSON.stringify(levels));
                                updateClubLevel(club_id, newLevel, clubs, levels);

                                // Recalcular cost y profitPerHour para la alerta
                                const newCost = calculateCost(club.cost, newLevel);
                                const newProfitPerHour = calculateProfitPerHour(club.cost, newLevel, club.name);

                                // Actualizar la alerta con los nuevos valores
                                document.getElementById('alertSecondSubtitle').innerText = `${formatNumber(newProfitPerHour)}`;
                                document.getElementById('alertCost').innerHTML = `<p><iconify-icon icon="twemoji:coin" style="font-size: 35px;"></iconify-icon> ${formatNumber(newCost)}</p>`;

                                // Actualizar el costo y la clase del botón
                                const costColor = newCost <= score ? 'yellow' : 'gray';
                                const buttonClass = newCost <= score ? 'active' : 'inactive';
                                document.getElementById('alertCost').classList.remove('yellow', 'gray');
                                document.getElementById('alertCost').classList.add(costColor);
                                document.getElementById('actionButton').classList.remove('active', 'inactive');
                                document.getElementById('actionButton').classList.add(buttonClass);

                                // Actualizar el profitPerHour global
                                profitPerHour += newProfitPerHour - currentProfitPerHour;
                                localStorage.setItem(`profit_per_hour_${user_id}`, profitPerHour);
                                
                                // Actualizar el profitPerHour en el servidor
                                await updateProfitPerHour(user_id, newProfitPerHour - currentProfitPerHour);

                                closeAlertMenu();
                            } else {
                                alert('Error al actualizar el nivel');
                            }
                        } else {
                            shakeButton();
                        }

                        setTimeout(() => {
                            button.classList.remove('action-button--done');
                            isButtonAnimating = false;
                            closeAlertMenu();
                        }, 1000);
                    }, 2500); // Adjusted to match the fill animation duration
                }
            };

            document.getElementById('actionButton').addEventListener('click', currentActionButtonListener);
        }
        
        function updateClubLevel(clubId, newLevel, clubs) {
            const rectangles = document.querySelectorAll('.rectangle');
            rectangles.forEach(rectangle => {
                if (rectangle.getAttribute('data-club-id') === clubId) {
                    const levelElement = rectangle.querySelector('.section-left');
                    if (levelElement) {
                        levelElement.textContent = `lvl ${newLevel}`;
                    }

                    // Encontrar el club correspondiente
                    const club = clubs.find(c => c.name === clubId);
                    if (club) {
                        // Calcular el nuevo costo y profitPerHour
                        const cost = calculateCost(club.cost, newLevel);
                        clubProfitPerHour = calculateProfitPerHour(club.cost, newLevel, club.name);

                        // Actualizar el costo y profitPerHour en la interfaz
                        const sectionRightSpan = rectangle.querySelector('.section-right span');
                        if (sectionRightSpan) {
                            sectionRightSpan.textContent = formatNumber(cost);
                        }

                        const profitSpan = rectangle.querySelector('.profit-info span');
                        if (profitSpan) {
                            profitSpan.textContent = formatNumber(clubProfitPerHour);
                        }
                    }
                }
            });
        }

        function closeAlertMenu() {
            if (!isButtonAnimating) {
                document.getElementById('alertMenu').style.display = 'none';
                document.querySelector('.container').classList.remove('blur-content');
                document.querySelector('.navbar').classList.remove('blur-content');

                // Eliminar el evento del botón "Buy" al cerrar la alerta
                if (currentActionButtonListener) {
                    document.getElementById('actionButton').removeEventListener('click', currentActionButtonListener);
                    currentActionButtonListener = null;
                }
            }
        }

        function shakeButton() {
            const button = document.getElementById('actionButton');
            const originalPosition = button.style.transform || 'translateX(0)';
            const shakeAnimation = [
                { transform: originalPosition },
                { transform: 'translateX(10px)' },
                { transform: 'translateX(-10px)' },
                { transform: 'translateX(10px)' },
                { transform: 'translateX(-10px)' },
                { transform: originalPosition }
            ];
            const shakeTiming = {
                duration: 500,
                iterations: 1
            };

            button.animate(shakeAnimation, shakeTiming);
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            ripple.classList.add('ripple');

            button.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        }
    </script>
</body>
</html>