<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at center, #0047ab, #002357, #000000);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* Evita que la imagen sea seleccionable */
            -webkit-tap-highlight-color: transparent; /* Deshabilita el resaltado en dispositivos Android */
            transition: filter 0.3s ease;
        }

        * {
            margin: 0px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding-bottom: 80px;
        }

        .score {
            font-weight: bold;
            text-align: center;
            margin-top: 70px;
            font-size: 80px;
            display: flex;
            align-items: center;
        }

        .navbar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            height: 60px;
            border-radius: 50px;
            margin: 0 auto; /* Centra la barra de navegación */
            background-color: #222222;
            position: fixed;
            bottom: 0;
            user-select: none; /* Evita que los íconos sean seleccionables */
            -webkit-tap-highlight-color: transparent; /* Deshabilita el resaltado en dispositivos Android */
            z-index: 1000; /* Asegura que la barra de navegación esté por encima del contenido */
        }

        .navbar a {
            color: gray;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            position: relative;
        }

        .navbar a.active span, .navbar a.active iconify-icon {
            color: white;
        }

        .navbar a iconify-icon {
            font-size: 24px;
        }

        .navbar a.active::before {
            content: '';
            position: absolute;
            top: -7px;
            left: -14px;
            right: -14px;
            bottom: -7px;
            border-radius: 50px;
            background-color: rgba(0, 0, 0, 0.267);
            z-index: -1;
        }

        .rectangles {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 5px;
        }

        .rectangle {
            display: flex;
            align-items: center;
            background-color: #333;
            border-radius: 50px;
            border: 2px solid white;
            width: 95%;
            margin: 5px;
            padding: 5px;
            cursor: pointer;
        }

        .icon {
            margin: 10px;
            font-size: 45px;
        }

        .text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }

        .alertReward {
            font-size: 48px;
            margin-top: 25px;
            font-weight: bold;
        }

        .alertReward.yellow {
            color: yellow;
        }

        .alertReward.gray {
            color: gray;
        }

        .action-button {
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 48px;
            margin-top: 10px;
            padding: 0;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .action-button.active {
            background-color: #0066ff;
            color: white;
        }

        .action-button.inactive {
            background-color: #808080;
            color: white;
        }

        /* Estilos para la animación del botón */
        .action-button__text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            transition: opacity 0.3s ease-in-out;
        }

        .action-button__progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }

        .action-button__progress-track {
            stroke: rgba(255, 255, 255, 0.2);
            transition: r 0.3s ease-in-out, stroke-width 0.3s ease-in-out;
        }

        .action-button__progress-fill {
            stroke: white;
            stroke-dashoffset: 125.66;
            transition: stroke-dashoffset 2s linear;
        }

        .action-button__progress-check {
            stroke: white;
            stroke-dashoffset: 34;
            transition: stroke-dashoffset 0.3s ease-out;
        }

        .action-button--running,
        .action-button--done {
            width: 48px;
            background-color: transparent !important;
        }

        .action-button--running .action-button__text,
        .action-button--done .action-button__text {
            opacity: 0;
        }

        .action-button--running .action-button__progress,
        .action-button--done .action-button__progress {
            visibility: visible;
            opacity: 1;
        }

        .action-button--running .action-button__progress-track {
            stroke-width: 8;
        }

        .action-button--running .action-button__progress-fill {
            stroke-dashoffset: 0;
        }

        .action-button--done .action-button__progress-check {
            stroke-dashoffset: 0;
        }

        .alert-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background-color: #333;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .alert-menu .close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }

        .alert-text {
            font-size: 24px;
        }

        .blur-content {
            filter: blur(5px);
            pointer-events: none;
            transition: filter 0.3s ease;
        }

        .daily-reward-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            border: 2px solid white;
            background-color: #333;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .daily-reward-menu .close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }

        .daily-reward-menu .calendar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-top: 20px;
        }

        .daily-reward-menu .day {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #444; /* No disponible por defecto */
            border-radius: 20px;
            padding: 5px;
            font-size: 18px;
            cursor: pointer;
            position: relative;
        }

        .daily-reward-menu .day.claimed {
            background-color: #0066ff; /* Ya reclamado */
            cursor: default;
        }

        .daily-reward-menu .day.available {
            background-color: rgb(11, 62, 121); /* Disponible para reclamar */
            border: 3px solid #0066ff;
        }

        .daily-reward-menu .day:last-child:nth-child(3n - 1) {
            grid-column: 2 / 4;
        }

        .daily-reward-menu .day:last-child:nth-child(3n - 2) {
            grid-column: 1 / 4;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 100%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: bold;
        }

        .tooltip .tooltiptext::after {
            content: " ";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: black transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="alert-container" style="text-align: center; position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 50px; display: none; z-index: 1000; max-width: 80%; width: auto; white-space: nowrap;"></div>
    <div class="container">
        <div class="score" id="scoreContainer">
            <iconify-icon icon="twemoji:coin" style="font-size: 60px;" id="coinIcon"></iconify-icon>
        </div>
        <h5 style="margin-top: 15px; font-size: 30px;">Earn more coins</h5>
        <h2 style="margin-top: 40px; text-align: left; width: 95%;">Youtube</h2>
        <div class="rectangles">
            <div class="rectangle" data-reward="100000" data-action="Watch" data-url="https://www.youtube.com/watch?v=QWDDYhMIZls" id="video1">
                <div class="icon">
                    <iconify-icon icon="logos:youtube-icon"></iconify-icon>
                </div>
                <div class="text">
                    <h3 style="margin-bottom: 5px;">Video 1</h3>
                    <p style="color: rgba(255, 255, 255, 0.5)"><span style="color: yellow; font-weight: bolder;"><iconify-icon icon="twemoji:coin" style="font-size: 12px;"></iconify-icon> <span class="reward">100K</span></span></p>
                </div>
                <div class="icon" style="right: 5px; font-size: 25px; transform: scaleX(-1)">
                    <iconify-icon icon="iconamoon:arrow-left-2-bold"></iconify-icon>
                </div>
            </div>
            <div class="rectangle" data-reward="100000" data-action="Watch" data-url="https://www.youtube.com/watch?v=TX2m-uzHqYM" id="video2">
                <div class="icon">
                    <iconify-icon icon="logos:youtube-icon"></iconify-icon>
                </div>
                <div class="text">
                    <h3 style="margin-bottom: 5px;">Video 2</h3>
                    <p style="color: rgba(255, 255, 255, 0.5)"><span style="color: yellow; font-weight: bolder;"><iconify-icon icon="twemoji:coin" style="font-size: 12px;"></iconify-icon> <span class="reward">100K</span></span></p>
                </div>
                <div class="icon" style="right: 5px; font-size: 25px; transform: scaleX(-1)">
                    <iconify-icon icon="iconamoon:arrow-left-2-bold"></iconify-icon>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 40px; text-align: left; width: 95%;">Daily Tasks</h2>
        <div class="rectangles">
            <div class="rectangle" data-reward="500" id="dailyRewardRectangle">
                <div class="icon">
                    <iconify-icon icon="tabler:calendar-check"></iconify-icon>
                </div>
                <div class="text">
                    <h3 style="margin-bottom: 5px;">Daily reward</h3>
                    <p style="color: rgba(255, 255, 255, 0.5)"><span style="color: yellow; font-weight: bolder;"><iconify-icon icon="twemoji:coin" style="font-size: 12px;"></iconify-icon> <span class="reward">500</span></span></p>
                </div>
                <div class="icon" style="right: 5px; font-size: 25px; transform: scaleX(-1)">
                    <iconify-icon icon="iconamoon:arrow-left-2-bold"></iconify-icon>
                </div>
            </div>
        </div>
        <h2 style="margin-top: 40px; text-align: left; width: 95%;">Tasks list</h2>
        <div class="rectangles">
            <div class="rectangle" data-reward="100000" data-action="Follow" data-url="https://t.me/PQP_Canal" id="canal">
                <div class="icon">
                    <iconify-icon icon="logos:telegram"></iconify-icon>
                </div>
                <div class="text">
                    <h4 style="margin-bottom: 5px;">Follow us on our Telegram channel</h4>
                    <p style="color: rgba(255, 255, 255, 0.5)"><span style="color: yellow; font-weight: bolder;"><iconify-icon icon="twemoji:coin" style="font-size: 12px;"></iconify-icon> <span class="reward">100K</span></span></p>
                </div>
                <div class="icon" style="right: 5px; font-size: 25px; transform: scaleX(-1)">
                    <iconify-icon icon="iconamoon:arrow-left-2-bold"></iconify-icon>
                </div>
            </div>
            <div class="rectangle" data-reward="100000" data-action="Join" data-url="https://t.me/PQP_Referidos" id="grupo">
                <div class="icon">
                    <iconify-icon icon="logos:telegram"></iconify-icon>
                </div>
                <div class="text">
                    <h4 style="margin-bottom: 5px;">Join our Telegram group</h4>
                    <p style="color: rgba(255, 255, 255, 0.5)"><span style="color: yellow; font-weight: bolder;"><iconify-icon icon="twemoji:coin" style="font-size: 12px;"></iconify-icon> <span class="reward">100K</span></span></p>
                </div>
                <div class="icon" style="right: 5px; font-size: 25px; transform: scaleX(-1)">
                    <iconify-icon icon="iconamoon:arrow-left-2-bold"></iconify-icon>
                </div>
            </div>
        </div>
    </div>
    <div class="navbar">
        <a href="index.html" id="exchangeNav"><iconify-icon icon="simple-icons:binance"></iconify-icon><span>Exchange</span></a>
        <a href="mine.html" id="mineNav"><iconify-icon icon="mdi:pickaxe"></iconify-icon><span>Mine</span></a>
        <a href="friends.html" id="friendsNav"><iconify-icon icon="clarity:group-solid"></iconify-icon><span>Friends</span></a>
        <a href="earn.html" id="earnNav" class="active"><iconify-icon icon="fa6-solid:coins"></iconify-icon><span>Earn</span></a>
        <a href="index.html#airdrop" id="airdropNav"><iconify-icon icon="et:wallet"></iconify-icon><span>Airdrop</span></a>
    </div>
    <div class="alert-menu" id="alertMenu">
        <div class="close" data-close="alert"><iconify-icon icon="ph:x-circle-duotone"></iconify-icon></div>
        <div class="icon" id="alertIcon"></div>
        <div class="alert-text" id="alertText"></div>
        <div class="subtitle" id="alertSubtitle"></div>
        <div class="alertReward" id="alertReward"></div>
        <button class="action-button" id="actionButton">Follow</button>
        <button class="action-button" id="checkButton">Check</button>
    </div>
</div>
<div class="daily-reward-menu" id="dailyRewardMenu">
    <div class="close" data-close="alert"><iconify-icon icon="ph:x-circle-duotone"></iconify-icon></div>
    <iconify-icon icon="tabler:calendar-check" style="font-size: 100px;"></iconify-icon>
    <h2>Daily Rewards</h2>
    <div class="calendar" id="dailyRewardsList"></div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        const user_id = tg.initDataUnsafe.user.id;
        let userData;
        let completedTasks = {};
        let videoTimers = {};
        let timerIntervals = {};
        let checkButtons = {};
        
        tg.ready();
        loadUserData().then(() => {
            loadCompletedTasks();
            loadSavedTimers();
        });
        
        tg.onEvent('backButtonClicked', () => {
            window.location.href = 'index.html';
        });

        tg.BackButton.show();

        earnNav.addEventListener('click', function(event) {
            if (window.location.pathname.includes('earn.html')) {
                event.preventDefault();
            }
        });

        document.querySelectorAll('.rectangle').forEach((rectangle, index) => {
            rectangle.addEventListener('click', () => {
                if (rectangle.id === 'dailyRewardRectangle') {
                    openDailyRewardMenu();
                    return;
                }

                const icon = rectangle.querySelector('.icon iconify-icon').getAttribute('icon');
                const text = rectangle.querySelector('.text h3, .text h4').innerText;
                const reward = parseFloat(rectangle.getAttribute('data-reward'));
                const action = rectangle.getAttribute('data-action');
                const url = rectangle.getAttribute('data-url');

                document.getElementById('alertIcon').innerHTML = `<iconify-icon icon="${icon}" style="font-size: 80px;"></iconify-icon>`;
                document.getElementById('alertText').innerText = text;
                document.getElementById('alertReward').innerHTML = `<p><iconify-icon icon="twemoji:coin" style="font-size: 35px;"></iconify-icon> ${formatNumber(reward)}</p>`;

                // Crear o recuperar el botón de acción
                let actionButton = document.createElement('button');
                actionButton.className = 'action-button active';
                actionButton.id = 'actionButton';
                actionButton.innerText = action;
                actionButton.dataset.url = url;
                actionButton.addEventListener('click', createRipple);

                const checkButton = document.createElement('button');
                checkButton.className = 'action-button active';
                checkButton.id = 'checkButton';
                checkButton.innerText = 'Check';
                checkButton.dataset.rectangleId = rectangle.id;
                checkButton.dataset.url = url;
                checkButton.addEventListener('click', createRipple);

                const alertMenu = document.getElementById('alertMenu');
                const oldActionButton = alertMenu.querySelector('#actionButton');
                const oldCheckButton = alertMenu.querySelector('#checkButton');
                if (oldActionButton) alertMenu.removeChild(oldActionButton);
                if (oldCheckButton) alertMenu.removeChild(oldCheckButton);
                alertMenu.appendChild(actionButton);
                alertMenu.appendChild(checkButton);

                if (rectangle.id.startsWith('video')) {
                    handleVideoRectangleClick(rectangle, actionButton, checkButton);
                } else {
                    // Verificar si la tarea ya ha sido completada o si hay un temporizador activo
                    if (completedTasks[rectangle.id]) {
                        checkButton.innerText = 'Claimed';
                        checkButton.classList.add('inactive');
                    } else if (timerIntervals[rectangle.id]) {
                        const endTime = new Date(timerIntervals[rectangle.id].endTime);
                        const remainingSeconds = Math.ceil((endTime - new Date()) / 1000);
                        if (remainingSeconds > 0) {
                            updateButtonDisplay(rectangle.id, remainingSeconds);
                        }
                    }
                    actionButton.addEventListener('click', handleActionButtonClick);
                    checkButton.addEventListener('click', handleCheckButtonClick);
                }

                document.getElementById('alertMenu').style.display = 'block';
                document.querySelector('.container').classList.add('blur-content');
                document.querySelector('.navbar').classList.add('blur-content');
            });
        });

        function handleVideoRectangleClick(rectangle, actionButton, checkButton) {
            const videoId = rectangle.id;
            const url = rectangle.getAttribute('data-url');
            const reward = parseFloat(rectangle.getAttribute('data-reward'));

            actionButton.addEventListener('click', () => handleVideoActionButtonClick(videoId, url));
            checkButton.addEventListener('click', () => handleVideoCheckButtonClick(videoId, reward, checkButton));
            
            updateVideoCheckButtonState(videoId, checkButton);
        }

        function handleVideoActionButtonClick(videoId, url) {
            if (!videoTimers[videoId]) {
                videoTimers[videoId] = {
                    startTime: Date.now(),
                    endTime: Date.now() + 60 * 60 * 1000, // 60 minutes
                    claimed: false
                };
                localStorage.setItem(`videoTimers_${user_id}`, JSON.stringify(videoTimers));
            }
            window.open(url, '_blank');
            updateVideoCheckButtonState(videoId, document.getElementById('checkButton'));
        }

        function updateVideoCheckButton(videoId, checkButton) {
            const timer = videoTimers[videoId];
            if (!timer) return;

            const now = Date.now();
            if (now < timer.endTime && !timer.claimed) {
                const remainingMinutes = Math.ceil((timer.endTime - now) / (60 * 1000));
                checkButton.innerText = `${remainingMinutes}m`;
                checkButton.classList.add('inactive');

                setTimeout(() => updateVideoCheckButton(videoId, checkButton), 60 * 1000); // Update every minute
            } else if (!timer.claimed) {
                checkButton.innerText = 'Claim';
                checkButton.classList.remove('inactive');
                checkButton.classList.add('active');
                checkButton.disabled = false;
            } else {
                checkButton.innerText = 'Claimed';
                checkButton.classList.add('inactive');
            }
        }

        async function handleVideoCheckButtonClick(videoId, reward, checkButton) {
            const timer = videoTimers[videoId];
            if (!timer || timer.claimed) {
                shakeButton(checkButton);
                return;
            }

            const now = Date.now();
            if (now < timer.endTime) {
                // Si aún no ha pasado el tiempo, mostrar el tiempo restante
                const remainingMinutes = Math.ceil((timer.endTime - now) / (60 * 1000));
                checkButton.innerText = `${remainingMinutes}m`;
                shakeButton(checkButton);
                return;
            }

            // Si el tiempo ha pasado y no se ha reclamado, iniciar animación del botón
            startButtonAnimation(checkButton);
            
            // Y proceder con la reclamación
            setTimeout(async () => {
                const response = await fetch('/claim_video_reward', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: user_id, 
                        video_id: videoId,
                        reward: reward
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    videoTimers[videoId].claimed = true;
                    localStorage.setItem(`videoTimers_${user_id}`, JSON.stringify(videoTimers));
                    
                    // Update UI
                    checkButton.innerText = 'Claimed';
                    
                    completedTasks = data.completed_tasks;
                
                    // Guardar datos en localStorage
                    localStorage.setItem(`score_${user_id}`, data.new_score);
                    localStorage.setItem(`completed_tasks_${user_id}`, JSON.stringify(completedTasks));
                    updateRectanglesAppearance();

                    // Finalizar animación
                    checkButton.classList.remove('action-button--running');
                    checkButton.classList.add('action-button--done');
                    
                    checkButton.querySelector('.action-button__progress-check').style.transition = 'stroke-dashoffset 0.3s ease-out';
                    checkButton.querySelector('.action-button__progress-check').style.strokeDashoffset = '0';

                    // Animación de monedas
                    closeAlertMenu();
                    animateCoins(reward);
                } else {
                    alert(data.error);
                }
            }, 2300); // Retraso de 2.3 segundos para simular la verificación
        }

        // Load video timers from localStorage
        function loadVideoTimers() {
            const storedTimers = localStorage.getItem(`videoTimers_${user_id}`);
            if (storedTimers) {
                videoTimers = JSON.parse(storedTimers);
                // Update timers for ongoing videos
                Object.keys(videoTimers).forEach(videoId => {
                    const rectangle = document.getElementById(videoId);
                    if (rectangle) {
                        const checkButton = checkButtons[videoId];
                        if (checkButton) {
                            updateVideoCheckButton(videoId, checkButton);
                        }
                    }
                });
            }
        }

        // Función para cargar los temporizadores guardados
        function loadSavedTimers() {
            const savedTimers = localStorage.getItem(`timerIntervals_${user_id}`);
            if (savedTimers) {
                timerIntervals = JSON.parse(savedTimers);
                Object.keys(timerIntervals).forEach(rectangleId => {
                    const endTime = new Date(timerIntervals[rectangleId].endTime);
                    if (endTime > new Date()) {
                        const rectangle = document.getElementById(rectangleId);
                        if (rectangle) {
                            const remainingSeconds = Math.ceil((endTime - new Date()) / 1000);
                            updateCheckButtonState(rectangleId, remainingSeconds, rectangle);
                        }
                    } else {
                        delete timerIntervals[rectangleId];
                    }
                });
                saveTimers();
            }
        }

        loadVideoTimers();

        const lastClaimed = userData.last_daily_reward_claimed ? new Date(userData.last_daily_reward_claimed) : null;
        const now = new Date();
        const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); // Establecer la hora a medianoche UTC
        
        // Cambiar el ícono del botón que abre el menú de recompensas diarias si la recompensa de hoy ya ha sido reclamada
        const dailyRewardRectangle = document.getElementById('dailyRewardRectangle');
        const arrowIconElement = dailyRewardRectangle.querySelector('.icon:last-child iconify-icon');
        if (lastClaimed && lastClaimed >= today) {
            arrowIconElement.setAttribute('icon', 'openmoji:check-mark');
            arrowIconElement.style.fontSize = '35px';
            arrowIconElement.style.transform = 'scaleX(-1)';
        } else {
            arrowIconElement.setAttribute('icon', 'iconamoon:arrow-left-2-bold');
            arrowIconElement.style.fontSize = '25px';
        }

        function updateCheckButtonState(rectangleId, remainingSeconds, rectangle) {
            if (timerIntervals[rectangleId] && timerIntervals[rectangleId].interval) {
                clearInterval(timerIntervals[rectangleId].interval);
            }

            const endTime = new Date(Date.now() + remainingSeconds * 1000);
            rectangle.dataset.endTime = endTime.toISOString();

            const intervalId = setInterval(() => {
                const now = new Date();
                const remainingSeconds = Math.ceil((endTime - now) / 1000);
                updateButtonDisplay(rectangleId, remainingSeconds);
                if (remainingSeconds <= 0) {
                    clearInterval(intervalId);
                    delete timerIntervals[rectangleId];
                    saveTimers();
                }
            }, 1000);

            timerIntervals[rectangleId] = { interval: intervalId, endTime: endTime.toISOString() };
            saveTimers();
            updateButtonDisplay(rectangleId, remainingSeconds);
        }

        function updateButtonDisplay(rectangleId, remainingSeconds) {
            const checkButton = document.querySelector(`button[data-rectangle-id="${rectangleId}"]`);
            if (checkButton) {
                if (remainingSeconds > 0) {
                    checkButton.classList.remove('active');
                    checkButton.classList.add('inactive');
                    checkButton.innerText = `${remainingSeconds}s`;
                } else {
                    checkButton.disabled = false;
                    checkButton.classList.remove('inactive');
                    checkButton.classList.add('active');
                    checkButton.innerText = 'Check';
                }
            }
        }
        
        function saveTimers() {
            localStorage.setItem(`timerIntervals_${user_id}`, JSON.stringify(timerIntervals));
        }

        function updateVideoCheckButtonState(videoId, checkButton) {
            const timer = videoTimers[videoId];
            if (!timer) {
                checkButton.innerText = 'Watch video first';
                checkButton.classList.add('inactive');
                return;
            }

            const now = Date.now();
            if (now < timer.endTime && !timer.claimed) {
                const remainingMinutes = Math.ceil((timer.endTime - now) / (60 * 1000));
                checkButton.innerText = `${remainingMinutes}m`;
                checkButton.classList.add('inactive');

                setTimeout(() => updateVideoCheckButtonState(videoId, checkButton), 60 * 1000); // Update every minute
            } else if (!timer.claimed) {
                checkButton.innerText = 'Claim';
                checkButton.classList.remove('inactive');
                checkButton.classList.add('active');
                checkButton.disabled = false;
            } else {
                checkButton.innerText = 'Claimed';
                checkButton.classList.add('inactive');
            }
        }

        function handleCheckButtonClick(event) {
            const checkButton = event.target;
            const rectangleId = checkButton.dataset.rectangleId;
            const rectangle = document.getElementById(rectangleId);
            const url = checkButton.dataset.url;
            const reward = parseFloat(rectangle.getAttribute('data-reward'));

            // Verificar si hay un temporizador activo
            if (timerIntervals[rectangleId]) {
                shakeButton(checkButton);
                const endTime = new Date(timerIntervals[rectangleId].endTime);
                const remainingSeconds = Math.ceil((endTime - new Date()) / 1000);
                if (remainingSeconds > 0) {
                    updateButtonDisplay(rectangleId, remainingSeconds);
                    return;
                }
            }

            if (checkButton.classList.contains('inactive')) {
                shakeButton(checkButton);
                return;
            }

            // Llamar a la API de verificación
            verifyTelegramGroup(checkButton, rectangleId, url, reward);
        }

        function startButtonAnimation(button) {
            const text = button.textContent;
            button.innerHTML = `
                <span class="action-button__text">${text}</span>
                <svg class="action-button__progress" viewBox="0 0 48 48" width="48px" height="48px">
                    <circle class="action-button__progress-track" r="20" cx="24" cy="24" fill="none" stroke="#c7cad1" stroke-width="8" />
                    <circle class="action-button__progress-fill" r="20" cx="24" cy="24" fill="none" stroke="#000000" stroke-width="8" transform="rotate(-90,24,24)" stroke-dasharray="125.66 125.66" stroke-dashoffset="125.66" />
                    <polyline class="action-button__progress-check" points="12,24 20,32 36,16" fill="none" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="34 34" stroke-dashoffset="34" />
                </svg>
            `;

            event.preventDefault();

            const text2 = button.querySelector('.action-button__text');
            const progress = button.querySelector('.action-button__progress');
            const fill = button.querySelector('.action-button__progress-fill');
            const check = button.querySelector('.action-button__progress-check');

            // Reset animation state
            fill.style.transition = 'none';
            fill.style.strokeDashoffset = '125.66';
            check.style.transition = 'none';
            check.style.strokeDashoffset = '34';
            
            // Force reflow
            void button.offsetWidth;

            // Iniciar animación
            button.style.width = '48px';
            text2.style.opacity = '0';
            
            setTimeout(() => {
                button.classList.add('action-button--running');
                progress.style.visibility = 'visible';
                progress.style.opacity = '1';
                
                // Animación de llenado
                setTimeout(() => {
                    fill.style.transition = 'stroke-dashoffset 2s linear';
                    fill.style.strokeDashoffset = '0';
                }, 300);
            }, 300);
        }

        function verifyTelegramGroup(checkButton, rectangleId, url, reward) {
            // Iniciar animación del botón
            startButtonAnimation(checkButton);

            // Llamar a la API de verificación después de un retraso
            setTimeout(async () => {
                const response = await fetch('/verify_telegram_group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: user_id, 
                        url: url, 
                        reward: reward,
                        task_id: rectangleId
                    })
                });

                const data = await response.json();
                
                // Finalizar animación y manejar la respuesta
                finishButtonAnimation(checkButton, data, rectangleId, reward);
            }, 2300); // Retraso de 2.3 segundos para simular la verificación
        }

        function finishButtonAnimation(button, data, rectangleId, reward) {
            button.classList.remove('action-button--running');
            button.classList.add('action-button--done');
            
            button.querySelector('.action-button__progress-check').style.transition = 'stroke-dashoffset 0.3s ease-out';
            button.querySelector('.action-button__progress-check').style.strokeDashoffset = '0';

            setTimeout(() => {
                if (data.status === 'success') {
                    handleSuccessfulVerification(button, rectangleId, reward);
                } else if (data.status === 'already_completed') {
                    closeAlertMenu();
                } else {
                    handleFailedVerification(button, rectangleId);
                }
                 
                // Restaurar el ancho original del botón
                button.style.width = '100%';
                button.classList.remove('action-button--done');
                button.innerHTML = button.textContent;
            }, 1000);
        }

        function handleSuccessfulVerification(checkButton, rectangleId, reward) {
            // Actualizar el score
            localStorage.setItem(`score_${user_id}`, data.new_score);

            // Marcar la tarea como completada
            completedTasks = data.completed_tasks;
            localStorage.setItem(`completed_tasks_${user_id}`, JSON.stringify(completedTasks));
            updateRectanglesAppearance();

            // Animación de monedas
            closeAlertMenu();
            animateCoins(reward);
        }

        function handleFailedVerification(checkButton, rectangleId) {
            // El usuario no está en el grupo, mostrar mensaje en burbuja
            showAlertBubble("You're not a member of the group yet. Please join and try again.");

            const timerSeconds = 60;
            updateCheckButtonState(rectangleId, timerSeconds, document.getElementById(rectangleId));
        }

        function handleActionButtonClick(event) {
            const url = event.target.dataset.url;
            window.open(url, '_blank');
        }

        function setupEventListeners() {
            document.querySelector('.daily-reward-menu .close').addEventListener('click', closeDailyRewardMenu);
            document.querySelector('[data-close="alert"]').addEventListener('click', closeAlertMenu);

            document.addEventListener('click', (event) => {
                const alertMenu = document.getElementById('alertMenu');
                const dailyRewardMenu = document.getElementById('dailyRewardMenu');
                if (!alertMenu.contains(event.target) && !dailyRewardMenu.contains(event.target) && event.target.closest('.rectangle') === null && !event.target.closest('[data-close]')) {
                    closeAlertMenu();
                    closeDailyRewardMenu();
                }
            });
        }

        function showAlertBubble(message) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.textContent = message;
            alertContainer.style.display = 'block';
            
            // Ajustar el ancho del contenedor después de establecer el contenido
            setTimeout(() => {
                const maxWidth = window.innerWidth * 0.8; // 80% del ancho de la ventana
                if (alertContainer.offsetWidth > maxWidth) {
                    alertContainer.style.width = maxWidth + 'px';
                    alertContainer.style.whiteSpace = 'normal';
                }
            }, 0);

            setTimeout(() => {
                alertContainer.style.display = 'none';
                // Restablecer estilos
                alertContainer.style.width = 'auto';
                alertContainer.style.whiteSpace = 'nowrap';
            }, 3000);
        }

        function closeAlertMenu() {
            document.getElementById('alertMenu').style.display = 'none';
            document.querySelector('.container').classList.remove('blur-content');
            document.querySelector('.navbar').classList.remove('blur-content');
        }

        function formatNumber(num) {
            const basicUnits = ['', 'K', 'M', 'B', 'T', 'Q'];

            function generateUnit(n) {
                if (n < basicUnits.length) return basicUnits[n];

                let firstChar = String.fromCharCode(Math.floor((n - basicUnits.length) / 26) + 65);
                let secondChar = String.fromCharCode((n - basicUnits.length) % 26 + 65);
                return firstChar + secondChar;
            }

            let unitIndex = 0;
            while (num >= 1000 && unitIndex < 702) { // 702 = 26 * 27 (AA to ZZ)
                num /= 1000;
                unitIndex++;
            }

            return num.toFixed(2) + generateUnit(unitIndex);
        }

        async function openDailyRewardMenu() {
            const dailyRewardMenu = document.getElementById('dailyRewardMenu');
            const dailyRewardsList = document.getElementById('dailyRewardsList');
            dailyRewardsList.innerHTML = '';

            const streak = userData.daily_reward_streak || 0;
            const lastClaimed = userData.last_daily_reward_claimed ? new Date(userData.last_daily_reward_claimed) : null;
            const now = new Date();
            const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())); // Establecer la hora a medianoche UTC

            // Cambiar el ícono del botón que abre el menú de recompensas diarias si la recompensa de hoy ya ha sido reclamada
            const dailyRewardRectangle = document.getElementById('dailyRewardRectangle');
            const arrowIconElement = dailyRewardRectangle.querySelector('.icon:last-child iconify-icon');
            if (lastClaimed && lastClaimed >= today) {
                arrowIconElement.setAttribute('icon', 'openmoji:check-mark');
                arrowIconElement.style.fontSize = '35px';
                arrowIconElement.style.transform = 'scaleX(-1)';
            } else {
                arrowIconElement.setAttribute('icon', 'iconamoon:arrow-left-2-bold');
                arrowIconElement.style.fontSize = '25px';
            }

            for (let i = 1; i <= 10; i++) {
                const day = document.createElement('div');
                day.className = 'day tooltip';
                day.innerHTML = `
                    <h5 style="margin-bottom: 5px;">Day ${i}</h5>
                    <span><iconify-icon icon="twemoji:coin" style="font-size: 35px; margin: 10px, 10px"></iconify-icon></span>
                    <h5>${i * 500}</h5>
                    <div class="tooltiptext"></div>
                `;

                if (i <= streak) {
                    day.classList.add('claimed');
                    day.querySelector('.tooltiptext').innerText = 'Day already claimed';
                } else if (i === streak + 1 && lastClaimed && lastClaimed < today) {
                    day.classList.add('available');
                    day.querySelector('.tooltiptext').innerText = 'Day not available to claim';
                    day.addEventListener('click', () => handleDayClick(i));
                } else {
                    day.querySelector('.tooltiptext').innerText = 'Day not available to claim';
                }
                dailyRewardsList.appendChild(day);
            }

            // Ajustar el tamaño del último rectángulo
            adjustLastRectangle();

            dailyRewardMenu.style.display = 'block';
            document.querySelector('.container').classList.add('blur-content');
            document.querySelector('.navbar').classList.add('blur-content');
        }

        function closeDailyRewardMenu() {
            document.getElementById('dailyRewardMenu').style.display = 'none';
            document.querySelector('.container').classList.remove('blur-content');
            document.querySelector('.navbar').classList.remove('blur-content');
        }

        function adjustLastRectangle() {
            const days = document.querySelectorAll('.daily-reward-menu .day');
            if (days.length > 0) {
                const lastDay = days[days.length - 1];
                if (days.length % 3 === 2) {
                    lastDay.style.gridColumn = '2 / 4';
                } else if (days.length % 3 === 1) {
                    lastDay.style.gridColumn = '1 / 4';
                }
            }
        }

        async function handleDayClick(dayNumber) {
            const response = await fetch('/claim_daily_reward', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id })
            });

            const data = await response.json();
            if (data.status === 'success') {
                userData.daily_reward_streak = data.streak;
                userData.last_daily_reward_claimed = data.lastClaim
                
                // Guardar datos en localStorage
                localStorage.setItem(`user_data_${user_id}`, JSON.stringify(userData));
                
                closeDailyRewardMenu();
                animateCoins(data.reward_amount);
                updateDailyRewardAmount();
            } else {
                alert(data.error);
            }
        }

        function shakeButton(button) {
            const originalPosition = button.style.transform || 'translateX(0)';
            const shakeAnimation = [
                { transform: originalPosition },
                { transform: 'translateX(-10px)' },
                { transform: 'translateX(10px)' },
                { transform: 'translateX(-10px)' },
                { transform: 'translateX(10px)' },
                { transform: originalPosition }
            ];
            const shakeTiming = {
                duration: 500,
                iterations: 1
            };

            button.animate(shakeAnimation, shakeTiming);
        }

        function animateCoins(reward) {
            const coinsContainer = document.createElement('div');
            coinsContainer.style.position = 'fixed';
            coinsContainer.style.top = '0';
            coinsContainer.style.left = '0';
            coinsContainer.style.width = '100vw';
            coinsContainer.style.height = '100vh';
            coinsContainer.style.overflow = 'hidden';
            coinsContainer.style.pointerEvents = 'none';
            coinsContainer.style.zIndex = '9999';
            document.body.appendChild(coinsContainer);

            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const numCoins = 300;
            const duration = 1500;
            const staggerDuration = 750;

            // Crear el número en el centro (invisible inicialmente)
            const rewardText = document.createElement('div');
            rewardText.style.position = 'absolute';
            rewardText.style.left = '50%';
            rewardText.style.top = '50%';
            rewardText.style.transform = 'translate(-50%, -50%)';
            rewardText.style.fontSize = `${Math.min(window.innerWidth / 4, 300)}px`;
            rewardText.style.fontWeight = 'bold';
            rewardText.style.fontFamily = "'Poppins', 'Arial', sans-serif";
            rewardText.style.background = 'linear-gradient(to bottom, #ffd700 0%, #ffcc00 50%, #cca300 100%)';
            rewardText.style.webkitBackgroundClip = 'text';
            rewardText.style.webkitTextFillColor = 'transparent';
            rewardText.style.textShadow = `
                3px 3px 6px rgba(0,0,0,0.2),
                0 0 5px rgba(255,215,0,0.5),
                0 0 10px rgba(255,215,0,0.3)
            `;
            rewardText.style.filter = 'drop-shadow(0 0 2px rgba(255,215,0,0.5))';
            rewardText.style.opacity = '0';
            rewardText.textContent = formatNumber(reward);
            coinsContainer.appendChild(rewardText);

            let coinsArrived = 0;
		
			// Crear y animar las monedas
			for (let i = 0; i < numCoins; i++) {
				const coin = document.createElement('div');
				coin.style.position = 'absolute';
				coin.style.width = '30px';
				coin.style.height = '30px';
				coin.style.borderRadius = '50%';
				coin.innerHTML = '🪙';
				coin.style.fontSize = '30px';
				
				// Determinar el borde de inicio
				const border = Math.floor(Math.random() * 4);
				let startX, startY;
				
				const offset = 100; // Distancia adicional fuera de la pantalla
				
				switch(border) {
					case 0: // Top
						startX = Math.random() * window.innerWidth;
						startY = -30 - offset;
						break;
					case 1: // Right
						startX = window.innerWidth + 30 + offset;
						startY = Math.random() * window.innerHeight;
						break;
					case 2: // Bottom
						startX = Math.random() * window.innerWidth;
						startY = window.innerHeight + 30 + offset;
						break;
					case 3: // Left
						startX = -30 - offset;
						startY = Math.random() * window.innerHeight;
						break;
				}
				
				coin.style.left = `${startX}px`;
				coin.style.top = `${startY}px`;
				
				coinsContainer.appendChild(coin);
		
				const endX = centerX + (Math.random() - 0.5) * rewardText.offsetWidth * 0.8;
				const endY = centerY + (Math.random() - 0.5) * rewardText.offsetHeight * 0.8;
		
				const delay = Math.random() * staggerDuration;
		
				coin.animate([
					{ transform: 'scale(1)', opacity: 0, offset: 0 },
					{ transform: 'scale(1)', opacity: 1, offset: 0.1 },
					{ transform: 'scale(0.8)', opacity: 1, offset: 0.8 },
					{ transform: 'scale(0)', opacity: 0, offset: 1 }
				], {
					duration: duration,
					delay: delay,
					easing: 'ease-in',
					fill: 'forwards'
				});
		
				coin.animate([
					{ left: `${startX}px`, top: `${startY}px` },
					{ left: `${endX}px`, top: `${endY}px` }
				], {
					duration: duration,
					delay: delay,
					easing: 'ease-in',
					fill: 'forwards'
				}).onfinish = () => {
					coinsArrived++;
					const progress = coinsArrived / numCoins;
					rewardText.style.opacity = progress.toString();
				};
			}
		
			setTimeout(() => {
                // Mantener la animación estática por 1 segundo
                setTimeout(() => {
                    coinsContainer.remove();
                }, 1000);  // 1 segundo de espera
            }, duration + staggerDuration + 500);
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            ripple.classList.add('ripple');

            button.appendChild(ripple);

            ripple.addEventListener('animationend', () => {
                ripple.remove();
            });
        }

        async function loadUserData() {
            // Intentar cargar datos desde localStorage
            let storedData = localStorage.getItem(`user_data_${user_id}`);
            
            if (!storedData || isDataInvalid(JSON.parse(storedData))) {
                // Si no hay datos almacenados o son inválidos, obtener del servidor
                try {
                    const response = await fetch(`/get_user_data?user_id=${user_id}`);
                    userData = await response.json();
                    
                    // Guardar datos en localStorage
                    localStorage.setItem(`user_data_${user_id}`, JSON.stringify(userData));
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    userData = {}; // Establecer un objeto vacío en caso de error
                }
            } else {
                userData = JSON.parse(storedData);
            }

            updateDailyRewardAmount();
        }

        function isDataInvalid(data) {
            // Verificar si los datos son válidos
            return !data || typeof data !== 'object' || 
                data.daily_reward_streak === undefined || 
                data.last_daily_reward_claimed === undefined;
        }

        async function loadCompletedTasks() {
            let tasksStored = localStorage.getItem(`completed_tasks_${user_id}`);
            
            if (!tasksStored || !isValidJSON(tasksStored)) {
                try {
                    const response = await fetch(`/get_completed_tasks?user_id=${user_id}`);
                    const data = await response.json();
                    completedTasks = data.completed_tasks;
                
                    // Guardar datos en localStorage
                    localStorage.setItem(`completed_tasks_${user_id}`, JSON.stringify(completedTasks));
                } catch (error) {
                    console.error('Error loading completed tasks:', error);
                    completedTasks = {};
                }
            } else {
                completedTasks = JSON.parse(tasksStored);
            }

            updateRectanglesAppearance();
            setupEventListeners();
        }

        function isValidJSON(str) {
            try {
                JSON.parse(str);
                return true;
            } catch (e) {
                return false;
            }
        }

        function updateRectanglesAppearance() {
            document.querySelectorAll('.rectangle').forEach(rectangle => {
                const taskId = rectangle.id;
                if (completedTasks[taskId]) {
                    const arrowIconElement = rectangle.querySelector('.icon:last-child iconify-icon');
                    arrowIconElement.setAttribute('icon', 'openmoji:check-mark');
                    arrowIconElement.style.fontSize = '35px';
                    arrowIconElement.style.transform = 'scaleX(-1)';
                }
            });
        }

        function updateDailyRewardAmount() {
            const streak = userData.daily_reward_streak || 0;
            const baseReward = 500;
            const rewardAmount = baseReward * (streak + 1);
            
            const rewardElement = document.querySelector('#dailyRewardRectangle .reward');
            if (rewardElement) {
                rewardElement.textContent = formatNumber(rewardAmount);
            }
        }
    });
    </script>
</body>
</html>